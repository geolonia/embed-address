<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
  </head>
  <style>
    select,
    input {
      width: 200px;
      height: 30px;
    }
  </style>
  <body>
    <div id="geolonia"></div>
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script>
      $(document).ready(() => {
        const $geolonia = $("#geolonia");
        const $button = $("<button>geolocation</button>");
        const $prefecture = $('<select id="prefecture" value=""></select>');
        const $city = $('<select id="city" value=""></select>');
        const $smallArea = $('<select id="smallArea" value=""></select>');
        const $address = $('<input id="address" />');
        const $form = $(`<div></div>`);

        const initPrefecture = () => {
          $prefecture.append('<option value="">(都道府県)</option>');
        }
        const initCity = () => {
          $city.empty()
          $city.append('<option value="">(市町村)</option>')
        }
        const initSmallArea = () => {
          $smallArea.empty()
          $smallArea.append('<option value="">(字名)</option>')
        }

        const fetchCities = (prefCode) => {
          initCity()
          return fetch(`./data/cities/${prefCode}.json`)
            .then(res => res.json())
            .then(items => {
              items.forEach(item => {
                $city.append(`<option value="${item.cityCode}">${item.name}</option>`)
              })
            })
        }
        const fetchSmallAreas = (cityCode) => {
          initSmallArea()
          return fetch(`./data/smallAreas/${cityCode}.json`)
            .then(res => res.json())
            .then(items => {
              const names = items.map(item => item.name)
              const uniqueAreas = names.reduce((prev, name, index) => {
                if(names.indexOf(name) === index) {
                  prev.push(items[index])
                }
                return prev
              }, [])
              uniqueAreas.forEach(item => {
                $smallArea.append(`<option value="${item.smallAreaCode}">${item.name}</option>`)
              })
            })
        }

        initPrefecture()
        initCity()
        initSmallArea()

        fetch("./data/prefectures.json")
          .then((res) => res.json())
          .then((items) => {
            items.forEach((item) => {
              $prefecture.append(
                `<option value="${item.prefCode}">${item.name}</option>`
              );
            });
          });

        $prefecture.on("change", event => {
          const prefCode = event.target.value
          if(prefCode) {
            fetchCities(prefCode)
          }
        });

        $city.on('change', event => {
          const cityCode = event.target.value
          if(cityCode) {
            fetchSmallAreas(cityCode)
          }
        })

        $button.on("click", () => {
          window.navigator.geolocation.getCurrentPosition(
            (position) => {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;
              Promise.all([fetchCities('25'), fetchSmallAreas('25214')]).then(() => {
                $prefecture.val('25')
                $city.val('25214')
                $smallArea.val('37000010')
                $address.focus()
              })

            },
          );
        });

        $status = $('<span />')

        $address.on('focus', event => {
          $status.remove()
        })
        $address.on('blur', (event) => {
          const value = event.target.value
          if(value) {
            $status.text('送信中')
            $address.append($status)
            $address.after($status)
            setTimeout(() => {
              $status.text('送信しました')
            }, 2000)
          }
        })

        $form.append($button)
        $form.append($prefecture);
        $form.append($city);
        $form.append($smallArea);
        $form.append($address);
        $geolonia.append($form);
      });
    </script>
  </body>
</html>
